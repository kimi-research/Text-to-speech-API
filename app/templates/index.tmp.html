<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI TTS</title>
    <style>
        h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>テキストから音声へ</h1>
    <textarea id="textInput" placeholder="テキストを入力"></textarea>
    <button id="sendButton" onclick="sendText()">生成</button>

    <!-- 注意書きのスペース -->
    <div class="notice-container">
        <strong>ご利用時のご案内:</strong>
        <ul>
            <li>入力は20文字以内にしてください。</li>
            <li>音声の生成に時間がかかる場合があります。</li>
        </ul>
    </div>

    <script>
        let isProcessing = false; // 処理中かどうかを管理

        async function sendText() {
            if (isProcessing) {
                alert("現在処理中です。完了するまでお待ちください。");
                return;
            }

            const text = document.getElementById("textInput").value.trim();
            if (!text) {
                alert("テキストを入力してください。");
                return;
            }

            // 送信開始
            isProcessing = true;
            const button = document.getElementById("sendButton");
            button.disabled = true;
            button.textContent = "生成中...";

            const response = await fetch("{{ form_action }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ "text": text })
            });

            if (response.headers.get("content-type")?.includes("application/json")) {
                const result = await response.json();
                alert(result.message);
            }

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);

                const contentDisposition = response.headers.get("Content-Disposition");
                let filename = "downloaded_audio.wav";

                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="(.+)"/);
                    if (match) {
                        filename = match[1];
                    }
                }

                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
            // ここで処理完了を確実にリセット
            isProcessing = false;
            button.disabled = false;
            button.textContent = "生成";
        }
    </script>
</body>
</html>

